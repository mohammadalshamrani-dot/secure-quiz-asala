
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>توليد نتيجة الاختبار – التقاط صورة</title>
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="brand">
      <img class="logo" src="./logo-alasala.png" alt="ALASALA">
      <div class="title">كليات الأصالة – كلية القانون</div>
    </div>
    <div class="subtitle">منصة الاختبارات القصيرة</div>
  </header>

  <main class="wrapper">
    <section class="hero-card">
      <h1>توليد نتيجة الاختبار</h1>
      <p class="sub">املأ الحقول ثم اضغط "إنشاء النتيجة" لعرض بطاقة النتيجة مع زر التقاط الصورة.</p>
    </section>

    <section class="form-card">
      <div class="row">
        <button class="btn btn-prim" id="make">إنشاء النتيجة</button>
        <button class="btn btn-ghost" id="capture" disabled>التقاط صورة</button>
      </div>

      <div class="form-grid" style="margin-top:12px">
        <div><label>اسم الطالب</label><input id="studentName" placeholder="مثال: أحمد خالد"></div>
        <div><label>الرقم الجامعي (اختياري)</label><input id="studentId" placeholder="441234567"></div>
        <div><label>عنوان الاختبار</label><input id="quizTitle" placeholder="اختبار مهارات البحث القانوني"></div>
        <div><label>كود/معرّف الاختبار (إن وجد)</label><input id="quizId" placeholder="QZ-2025-001"></div>
        <div><label>الدرجة</label><input id="score" type="number" min="0" placeholder="8"></div>
        <div><label>من (الدرجة الكلية)</label><input id="outOf" type="number" min="1" placeholder="10"></div>
        <div><label>زمن الحل (دقيقة)</label><input id="minutes" type="number" min="0" placeholder="12"></div>
        <div><label>رابط تحقق رسمي (اختياري)</label><input id="verifyUrl" placeholder="ألصق رابط نتيجة منصة خارجية إن توفر"></div>
        <div style="grid-column:1/-1"><label>ملاحظات (اختياري)</label><textarea id="notes" placeholder="مثال: تم الحل دون مغادرة الصفحة."></textarea></div>
      </div>

      <div id="resultCard" class="result-card" style="display:none">
        <div class="result-head">
          <div style="display:flex; align-items:center; gap:10px">
            <img src="./logo-alasala.png" alt="logo" style="height:34px">
            <div>
              <div style="font-weight:800">منصة الاختبارات القصيرة – كلية القانون</div>
              <div class="small">ALASALA | Law College</div>
            </div>
          </div>
          <div class="score" id="scoreBox">—</div>
        </div>

        <div class="meta" id="meta"></div>

        <div class="qrrow">
          <div class="qrbox" id="qrBox">—</div>
          <div class="small" id="hashBox">
            <div><b>رمز التحقق:</b> <span id="sig">—</span></div>
            <div id="verifyHint">لا يوجد رابط تحقق.</div>
            <div>ختم جهاز: <span id="ua"></span></div>
          </div>
        </div>

        <div class="small" style="margin-top:8px" id="notesBox"></div>
        <div class="small" style="margin-top:8px; color:#999">تم تطوير المنصة بواسطة: د. محمد الشمراني – 2025</div>
      </div>
    </section>

    <footer class="footer">بعد التقاط الصورة: أرسلها لعضو هيئة التدريس.</footer>
  </main>

<script>
  function sha1(str){
    const enc = new TextEncoder().encode(str);
    return crypto.subtle.digest('SHA-1', enc).then(buf => {
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b => b.toString(16).padStart(2,'0')).join('');
    });
  }
  function nowISO(){ return new Date().toISOString(); }

  function makeResult(){
    const studentName = document.getElementById('studentName').value.trim();
    const studentId   = document.getElementById('studentId').value.trim();
    const quizTitle   = document.getElementById('quizTitle').value.trim();
    const quizId      = document.getElementById('quizId').value.trim();
    const score       = Number(document.getElementById('score').value);
    const outOf       = Number(document.getElementById('outOf').value);
    const minutes     = Number(document.getElementById('minutes').value);
    const verifyUrl   = document.getElementById('verifyUrl').value.trim();
    const notes       = document.getElementById('notes').value.trim();
    const ts          = nowISO();
    const uaShort     = navigator.userAgent.slice(0, 80);

    if(!quizTitle || isNaN(score) || isNaN(outOf) || outOf <= 0){
      alert('يرجى تعبئة العنوان والدرجة ومن.');
      return;
    }

    document.getElementById('scoreBox').textContent = `${score} / ${outOf}`;

    const meta = [
      ['اسم الطالب', studentName || '—'],
      ['الرقم الجامعي', studentId || '—'],
      ['عنوان الاختبار', quizTitle],
      ['كود الاختبار', quizId || '—'],
      ['زمن الحل (دقيقة)', isNaN(minutes)? '—' : String(minutes)],
      ['وقت الختم', new Date(ts).toLocaleString()]
    ];
    const metaEl = document.getElementById('meta');
    metaEl.innerHTML = meta.map(([k,v]) => `<div><b>${k}:</b> ${String(v).replace(/</g,'&lt;')}</div>`).join('');

    const qrBox = document.getElementById('qrBox');
    qrBox.innerHTML = '';
    if(verifyUrl){
      new QRCode(qrBox, { text: verifyUrl, width: 120, height: 120 });
      document.getElementById('verifyHint').innerHTML = `رابط تحقق: <a href="${verifyUrl}" target="_blank">${verifyUrl}</a>`;
    }else{
      qrBox.textContent = '—';
      document.getElementById('verifyHint').textContent = 'لا يوجد رابط تحقق.';
    }

    const payload = JSON.stringify({studentName, studentId, quizTitle, quizId, score, outOf, minutes, ts, uaShort});
    sha1(payload).then(sig => { document.getElementById('sig').textContent = sig.slice(0,16).toUpperCase(); });

    document.getElementById('ua').textContent = uaShort;
    document.getElementById('notesBox').innerHTML = notes ? `<b>ملاحظات:</b> ${notes.replace(/</g,'&lt;')}` : '';

    document.getElementById('resultCard').style.display = 'block';
    document.getElementById('capture').disabled = false;
    window.scrollTo({top: document.getElementById('resultCard').offsetTop - 20, behavior:'smooth'});
  }

  function capture(){
    const node = document.getElementById('resultCard');
    html2canvas(node, {scale:2}).then(canvas => {
      const link = document.createElement('a');
      link.download = 'result.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  }

  document.getElementById('make').addEventListener('click', makeResult);
  document.getElementById('capture').addEventListener('click', capture);
</script>
</body>
</html>
