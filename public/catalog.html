<!DOCTYPE html><html lang='ar' dir='rtl'><head>
<meta charset='utf-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>قائمة الاختبارات – الأصالة</title>
<style>
body{margin:0;background:#0b1023;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Arabic',sans-serif}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid #1f2a44}
header img{height:32px;border-radius:6px}
main{max-width:1000px;margin:20px auto;padding:0 16px}
.tools{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.input,select{padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#fff}
.grid{display:grid;gap:12px;grid-template-columns:1fr}
@media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
.card{background:#0b1220;border:1px solid #1f2a44;border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:10px}
.meta{color:#c7aa6a;font-size:13px;margin:-2px 0 2px}
.btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(180deg,#a5072e,#7f0524);color:#fff;font-weight:800;cursor:pointer}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid #334155;border-radius:999px;padding:4px 10px;font-size:12px}
.pill.warn{border-color:#a5072e;color:#ffd8df}
.pill.info{border-color:#334155;color:#cbd5e1}
.muted{color:#94a3b8}
dialog{border:none;border-radius:14px;padding:0;overflow:hidden}
.qr-box{background:#0b1220;border:1px solid #1f2a44;padding:16px}
.qr-head{display:flex;justify-content:space-between;align-items:center;background:#0b1023;color:#e5e7eb;padding:10px 14px}
.close{background:transparent;border:1px solid #334155;border-radius:10px;color:#e5e7eb;padding:6px 10px;cursor:pointer}
</style></head><body>
<header>
  <div style="font-weight:700">قائمة الاختبارات المتاحة</div>
  <img src="/assets/alasala-logo.jpg" alt="ALASALA"/>
</header>
<main>
  <div class="tools">
    <select id="status" class="input">
      <option value="open">المتاحة الآن</option>
      <option value="all">الكل</option>
    </select>
    <input id="q" class="input" placeholder="بحث باسم المقرر / الكود / المشرف / العنوان" style="flex:1;min-width:220px">
  </div>
  <div id="list" class="grid"></div>
  <p id="empty" class="muted" style="display:none">لا توجد اختبارات حسب الفلتر الحالي.</p>
</main>
<dialog id="qrDialog">
  <div class="qr-head">
    <div>رمز QR للاختبار</div>
    <button class="close" onclick="document.getElementById('qrDialog').close()">إغلاق</button>
  </div>
  <div class="qr-box">
    <div id="qrTarget" style="display:flex;justify-content:center"></div>
    <p id="qrLink" class="muted" style="text-align:center;margin-top:8px"></p>
  </div>
</dialog>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
const $=s=>document.querySelector(s);
const fmt=ts=>ts?new Date(ts).toLocaleString('ar-SA',{hour12:false}):'—';
const origin=location.origin;

async function load(){
  const status=$('#status').value;
  const r=await fetch('/api/quizzes?status='+encodeURIComponent(status));
  const data=await r.json();
  render(data);
}
function render(items){
  const q=($('#q').value||'').trim().toLowerCase();
  const list=$('#list'); list.innerHTML='';
  const filtered=items.filter(x=>{
    const hay=(x.title+' '+x.courseName+' '+x.courseCode+' '+x.instructorName).toLowerCase();
    return !q || hay.includes(q);
  });
  $('#empty').style.display=filtered.length?'none':'block';
  filtered.forEach(x=>{
    const link=origin+'/q/'+x.id;
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div>
        <h3 style="margin:0 0 6px">${x.title}</h3>
        <div class="meta">المقرر: <b>${x.courseName||'—'}</b> ${x.courseCode?('('+x.courseCode+')'):''} — المشرف: <b>${x.instructorName||'—'}</b></div>
        <div class="row">
          ${x.requireApproval?'<span class="pill warn">يتطلب موافقة</span>':''}
          ${x.singleAttempt?'<span class="pill info">محاولة واحدة</span>':'<span class="pill info">محاولات متعددة</span>'}
          <span class="pill">أسئلة: ${x.questionCount}</span>
          <span class="pill">${x.perQuestionSec||60}ث/س</span>
          <span class="pill">التاريخ: ${fmt(x.examStart)}</span>
        </div>
      </div>
      <div class="row" style="margin-top:6px">
        <button class="btn" onclick="location.href='${link}'">بدء الاختبار</button>
        <button class="btn" style="background:#0b1220;border:1px solid #334155;color:#e5e7eb" onclick="openQR('${link}')">عرض QR</button>
      </div>`;
    list.appendChild(card);
  });
}
function openQR(link){
  const dlg=document.getElementById('qrDialog'); const box=document.getElementById('qrTarget'); box.innerHTML='';
  QRCode.toCanvas(link,{width:260,margin:2},(err,canvas)=>{ if(err){ box.textContent='تعذر إنشاء QR'; return;} box.appendChild(canvas); });
  document.getElementById('qrLink').textContent=link; dlg.showModal();
}
document.getElementById('status').addEventListener('change',load);
document.getElementById('q').addEventListener('input',load);
load();
</script></body></html>