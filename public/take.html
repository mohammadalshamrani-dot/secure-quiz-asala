<!DOCTYPE html><html lang='ar' dir='rtl'><head>
<meta charset='utf-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>اختبار – الأصالة</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Arabic',sans-serif;margin:0;background:#0b1023;color:#e5e7eb}
header{padding:12px 16px;border-bottom:1px solid #1f2a44;display:flex;justify-content:space-between;align-items:center}
main{padding:16px;max-width:820px;margin:auto}
.input,.btn{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#fff}
.btn{cursor:pointer;background:linear-gradient(180deg,#22c55e,#16a34a);border:none;font-weight:800}
.muted{color:#94a3b8;font-size:13px}
.q{margin:8px 0;font-size:18px}
.choices{display:grid;gap:8px;margin-top:10px}
.choice{display:flex;gap:10px;background:#0b1220;border:1px solid #334155;border-radius:10px;padding:10px}
.timers{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:14px}
.progress{height:6px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden;margin-top:8px}
.bar{height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4);width:0%}
.hidden{display:none !important}
.score{font-size:36px;font-weight:800;margin:8px 0}
</style></head><body>
<header><div>منصة الاختبارات – الأصالة</div><img src="/assets/alasala-logo.jpg" style="height:30px;border-radius:6px"/></header>
<main id="welcome">
  <h2 id="quizTitle"></h2>
  <p class="muted" id="note"></p>
  <input id="name" class="input" placeholder="أدخل اسمك الثلاثي"/>
  <button id="start" class="btn" disabled>ابدأ</button>
</main>
<main id="exam" class="hidden">
  <div class="timers"> <div>السؤال <span id="qIndex">1</span>/<span id="qTotal">1</span></div> <div>الوقت: <span id="sec">60</span> ث</div> </div>
  <div class="progress"><div id="bar" class="bar"></div></div>
  <div id="qText" class="q"></div><div id="choices" class="choices"></div>
  <div style="margin-top:10px"><button id="next" class="btn">التالي</button></div>
</main>
<main id="cancelled" class="hidden" style="padding:28px"><p>تم إلغاء هذه المحاولة بسبب الخروج من الصفحة.</p></main>
<main id="done" class="hidden" style="padding:28px"><div class="score"><span id="score"></span> / <span id="total"></span></div></main>
<script>
const $=s=>document.querySelector(s); const quizId=location.pathname.split('/').pop();
let QUIZ=null, idx=0, answers=[], timer=null, secs=60, attemptId=null, cheated=false;
async function loadQuiz(){ const r=await fetch('/api/quizzes/'+quizId); if(!r.ok){$('#quizTitle').textContent='غير موجود';return;} QUIZ=await r.json(); $('#quizTitle').textContent=QUIZ.title; $('#note').textContent='سيتم إلغاء المحاولة عند الخروج.'; $('#qTotal').textContent=QUIZ.questions.length; $('#start').disabled=false; }
$('#name').addEventListener('input',()=>$('#start').disabled=$('#name').value.trim().length<3);
$('#start').onclick=async()=>{ const rr=await fetch('/api/quizzes/'+quizId+'/attempts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:$('#name').value.trim()})}); const dd=await rr.json(); if(!rr.ok){alert(dd.error||'خطأ');return;} attemptId=dd.attemptId; startExam(); };
function startExam(){ idx=0; answers=[]; $('#welcome').classList.add('hidden'); $('#exam').classList.remove('hidden'); renderQ(); runTimer(); }
function renderQ(){ const q=QUIZ.questions[idx]; $('#qIndex').textContent=(idx+1); $('#qText').textContent=q.q; const box=$('#choices'); box.innerHTML=''; q.choices.forEach((c,i)=>{ const label=document.createElement('label'); label.className='choice'; label.innerHTML=`<input type="radio" name="q${idx}" value="${i}"> <span>${c}</span>`; box.appendChild(label); }); secs=QUIZ.perQuestionSec||60; $('#sec').textContent=secs; $('#bar').style.width='0%'; }
function runTimer(){ clearInterval(timer); const total=secs; timer=setInterval(()=>{ secs--; if(secs<0){ clearInterval(timer); submitQ(); return; } $('#sec').textContent=secs; $('#bar').style.width=((total-secs)/total*100)+'%'; },1000); }
function submitQ(){ const sel=document.querySelector('input[type=radio]:checked'); answers[idx]=sel?parseInt(sel.value,10):-1; idx++; if(idx>=QUIZ.questions.length){ submitAll(); return; } renderQ(); runTimer(); }
$('#next').onclick=submitQ;
async function submitAll(){ clearInterval(timer); const r=await fetch('/api/attempts/'+attemptId+'/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({answers})}); const d=await r.json(); if(d.status==='cancelled'){ $('#exam').classList.add('hidden'); $('#cancelled').classList.remove('hidden'); return; } $('#exam').classList.add('hidden'); $('#done').classList.remove('hidden'); $('#score').textContent=d.score; $('#total').textContent=d.total; }
function markCheat(){ if(!attemptId||cheated) return; cheated=true; fetch('/api/attempts/'+attemptId+'/cheat',{method:'POST'}); $('#exam').classList.add('hidden'); $('#cancelled').classList.remove('hidden'); }
document.addEventListener('visibilitychange',()=>{ if(document.hidden) markCheat(); }); window.addEventListener('blur',markCheat);
loadQuiz();
</script></body></html>