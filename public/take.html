<!DOCTYPE html><html lang="ar" dir="rtl"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>اختبار – منصة الأصالة</title>
<style>
 body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Arabic',sans-serif;margin:0;background:#0b1023;color:#e5e7eb}
 header,.footer{padding:12px 16px;border-bottom:1px solid #1f2a44;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
 header img{height:30px;border-radius:6px}
 main{padding:16px;max-width:820px;margin:auto}
 .input,.btn{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#fff}
 .btn{cursor:pointer;background:linear-gradient(180deg,#22c55e,#16a34a);border:none;font-weight:800}
 .btn[disabled]{opacity:.5;cursor:not-allowed}
 .muted{color:#94a3b8;font-size:13px}
 .q{margin:8px 0;font-size:18px;line-height:1.6}
 .choices{display:grid;gap:8px;margin-top:10px}
 .choice{display:flex;gap:10px;align-items:flex-start;background:#0b1220;border:1px solid #334155;border-radius:10px;padding:10px}
 .timers{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:14px;color:#cbd5e1}
 .pill{display:inline-flex;gap:6px;align-items:center;background:#0b1220;border:1px solid #334155;border-radius:999px;padding:6px 10px}
 .progress{height:6px;background:#0b1220;border:1px solid #334155;border-radius:999px;overflow:hidden;margin-top:8px}
 .bar{height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4);width:0%}
 .center{display:flex;justify-content:center;align-items:center}
 .hidden{display:none !important}
 .score{font-size:36px;font-weight:800;margin:8px 0}
 .notice{background:#0b1220;border:1px solid #334155;border-radius:12px;padding:12px;margin-top:10px}
</style>
</head><body>
<header>
  <div>منصة الاختبارات – الأصالة</div>
  <img src="/assets/alasala-logo.jpg" alt="ALASALA"/>
</header>

<main id="welcome">
  <h2 id="quizTitle"></h2>
  <div class="notice">
    <div><b>المقرر:</b> <span id="courseName">—</span> (<span id="courseCode">—</span>)</div>
    <div><b>المشرف:</b> <span id="instructorName">—</span></div>
    <div><b>النافذة الزمنية:</b> <span id="window">—</span></div>
  </div>
  <p class="muted" id="note"></p>
  <input id="name" class="input" placeholder="أدخل اسمك الثلاثي" autocomplete="name"/>
  <button id="start" class="btn" disabled>ابدأ</button>
</main>

<main id="waiting" class="hidden center" style="padding:28px">
  <div>
    <p class="q">تم تسجيلك. <b>بانتظار موافقة المشرف</b> للبدء.</p>
    <p class="muted">لا تغادر الصفحة. نُحدّث الحالة تلقائيًا…</p>
  </div>
</main>

<main id="exam" class="hidden">
  <div class="timers">
    <div class="pill">السؤال <span id="qIndex">1</span>/<span id="qTotal">1</span></div>
    <div class="pill">الوقت: <span id="sec">60</span> ث</div>
  </div>
  <div class="progress"><div id="bar" class="bar"></div></div>
  <div id="qText" class="q"></div>
  <div id="choices" class="choices"></div>
  <div class="footer">
    <button id="next" class="btn">التالي</button>
    <span class="muted">ينتقل تلقائيًا عند انتهاء الوقت.</span>
  </div>
</main>

<main id="cancelled" class="hidden center" style="padding:28px">
  <div>
    <p class="q">تم إلغاء هذه المحاولة بسبب الخروج من الصفحة/التطبيق.</p>
    <a href="" class="btn">حاول من جديد</a>
  </div>
</main>

<main id="done" class="hidden center" style="padding:28px">
  <div>
    <div class="score"><span id="score"></span> / <span id="total"></span></div>
    <div id="stamp" class="muted"></div>
    <div class="muted" style="margin-top:10px">تم تطوير المنصة بواسطة د. محمد الشمراني – 2025</div>
  </div>
</main>

<script>
const $ = s => document.querySelector(s);
const quizId = location.pathname.split('/').pop();
const elWelcome = $('#welcome'), elWaiting = $('#waiting'), elExam = $('#exam'), elDone = $('#done'), elCancelled = $('#cancelled');
const elTitle = $('#quizTitle'), elName = $('#name'), elStart = $('#start'), elQIndex = $('#qIndex'), elQTotal = $('#qTotal');
const elQText = $('#qText'), elChoices = $('#choices'), elNext = $('#next'), elSec = $('#sec'), elBar = $('#bar');
const elScore = $('#score'), elTotal = $('#total'), elStamp = $('#stamp'), elNote = $('#note');
const elCourseName=$('#courseName'), elCourseCode=$('#courseCode'), elInstructor=$('#instructorName'), elWindow=$('#window');

let QUIZ=null, idx=0, answers=[], timer=null, secs=60, attemptId=null, cheated=false;

function fmt(ts){
  if(!ts) return '—';
  return new Date(ts).toLocaleString('ar-SA',{hour12:false});
}

async function loadQuiz(){
  const res = await fetch('/api/quizzes/'+quizId);
  if(!res.ok){ elTitle.textContent='غير موجود'; return; }
  QUIZ = await res.json();
  elTitle.textContent = QUIZ.title;
  elQTotal.textContent = QUIZ.questions.length;
  elCourseName.textContent = QUIZ.courseName || '—';
  elCourseCode.textContent = QUIZ.courseCode || '—';
  elInstructor.textContent = QUIZ.instructorName || '—';
  elWindow.textContent = (QUIZ.examStart?fmt(QUIZ.examStart):'…') + ' → ' + (QUIZ.examEnd?fmt(QUIZ.examEnd):'…');
  elNote.textContent = (QUIZ.requireApproval ? 'سيبدأ الاختبار بعد موافقة المشرف. ' : '') + 'سيتم إلغاء المحاولة عند الخروج من الصفحة.';
}
elName.addEventListener('input', ()=> elStart.disabled = elName.value.trim().length < 3);

elStart.addEventListener('click', async ()=>{
  const name = elName.value.trim();
  const res = await fetch('/api/quizzes/'+quizId+'/attempts', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})
  });
  const data = await res.json();
  if(!res.ok){ alert(data.error||'خطأ'); return; }
  attemptId = data.attemptId;
  if(QUIZ.requireApproval && !data.approved){
    elWelcome.classList.add('hidden'); elWaiting.classList.remove('hidden');
    pollApproval();
  } else {
    startExam();
  }
});
async function pollApproval(){
  const t = setInterval(async ()=>{
    const r = await fetch('/api/attempts/'+attemptId);
    const d = await r.json();
    if(d.approved){
      clearInterval(t);
      elWaiting.classList.add('hidden'); startExam();
    }
  }, 1200);
}
function startExam(){
  idx = 0; answers = []; elWelcome.classList.add('hidden'); elExam.classList.remove('hidden');
  renderQ(); runTimer();
}
function renderQ(){
  const q=QUIZ.questions[idx];
  elQIndex.textContent = (idx+1);
  elQText.textContent = q.q;
  elChoices.innerHTML='';
  q.choices.forEach((c,i)=>{
    const label = document.createElement('label');
    label.className='choice';
    label.innerHTML = `<input type="radio" name="q${idx}" value="${i}" style="margin-top:3px"> <span>${c}</span>`;
    elChoices.appendChild(label);
  });
  secs = QUIZ.perQuestionSec || 60; elSec.textContent = secs; elBar.style.width='0%';
}
function runTimer(){
  clearInterval(timer);
  const total = secs;
  timer = setInterval(()=>{
    secs--; if(secs<0){ clearInterval(timer); submitQ(); return; }
    elSec.textContent = secs; elBar.style.width = ((total - secs)/total*100)+'%';
  },1000);
}
function submitQ(){
  const checked = elChoices.querySelector('input[type=radio]:checked');
  answers[idx] = checked ? parseInt(checked.value,10) : -1;
  idx++;
  if(idx >= QUIZ.questions.length){ return submitAll(); }
  renderQ(); runTimer();
}
elNext.addEventListener('click', submitQ);
async function submitAll(){
  clearInterval(timer);
  const res = await fetch('/api/attempts/'+attemptId+'/submit',{
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({answers})
  });
  const data = await res.json();
  if(data.status === 'cancelled') { elExam.classList.add('hidden'); elCancelled.classList.remove('hidden'); return; }
  elExam.classList.add('hidden'); elDone.classList.remove('hidden');
  elScore.textContent = data.score; elTotal.textContent = data.total;
  elStamp.textContent = new Date().toLocaleString('ar-SA',{hour12:false});
}
function markCheat(){ if(!attemptId || cheated) return; cheated = true; fetch('/api/attempts/'+attemptId+'/cheat', { method:'POST' }); elExam.classList.add('hidden'); elCancelled.classList.remove('hidden'); }
document.addEventListener('visibilitychange', ()=> { if(document.hidden) markCheat(); });
window.addEventListener('blur', markCheat);
loadQuiz();
</script>
</body></html>