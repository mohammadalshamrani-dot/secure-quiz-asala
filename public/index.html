<!DOCTYPE html><html lang='ar' dir='rtl'><head>
<meta charset='utf-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>لوحة الإدارة – الأصالة</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Arabic',sans-serif;margin:0;background:#0b1023;color:#e5e7eb}
header{padding:12px 16px;border-bottom:1px solid #1f2a44;display:flex;align-items:center;justify-content:space-between}
main{padding:18px;max-width:1100px;margin:auto}
.row{display:flex;gap:10px;flex-wrap:wrap}
.input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#fff}
.btn{padding:12px 16px;border-radius:10px;border:none;background:#22c55e;color:#001;font-weight:800;cursor:pointer}
.btn.secondary{background:transparent;border:1px solid #334155;color:#e5e7eb}
.pill{display:inline-flex;align-items:center;gap:6px;background:#0b1220;border:1px solid #334155;border-radius:999px;padding:6px 10px;font-size:12px}
.card{background:#0b1220;border:1px solid #1f2a44;padding:16px;border-radius:12px;margin-bottom:12px}
.muted{color:#94a3b8}
</style></head><body>
<header><div>منصة الاختبارات – الأصالة</div><img src="/assets/alasala-logo.jpg" style="height:34px;border-radius:6px"/></header>
<main>
  <div class="card" id="authCard">
    <h3>تسجيل / دخول المدرّس</h3>
    <div class="row">
      <input id="email" class="input" placeholder="البريد الجامعي">
      <input id="name" class="input" placeholder="الاسم الكامل (للتسجيل فقط)">
      <input id="pwd" class="input" type="password" placeholder="كلمة المرور">
    </div>
    <div class="row">
      <button class="btn" id="doRegister">تسجيل جديد</button>
      <button class="btn secondary" id="doLogin">دخول</button>
    </div>
    <div id="authMsg" class="muted"></div>
  </div>

  <div class="card" id="builder" style="display:none">
    <h3>إنشاء اختبار جديد</h3>
    <div class="row">
      <input id="title" class="input" placeholder="عنوان الاختبار" />
      <input id="courseName" class="input" placeholder="اسم المقرر"/>
      <input id="courseCode" class="input" placeholder="رمز المقرر"/>
      <input id="instructorName" class="input" placeholder="اسم المشرف"/>
      <input id="perSec" class="input" type="number" min="5" value="60" placeholder="الزمن لكل سؤال (ثوان)"/>
    </div>
    <div class="row">
      <label class="pill"><input type="checkbox" id="singleAttempt" checked> محاولة واحدة لكل اسم</label>
      <label class="pill"><input type="checkbox" id="requireApproval"> يتطلب موافقة المشرف</label>
    </div>
    <div class="row">
      <input id="examDate" class="input" type="datetime-local" placeholder="تاريخ/وقت الاختبار (اختياري)"/>
    </div>

    <p class="muted">اختر نوع السؤال: <b>اختيارات متعددة</b> أو <b>صح/خطأ</b>.</p>
    <div id="qList"></div>
    <button class="btn" id="addQuestion">إضافة سؤال</button>
    <hr />
    <button class="btn" id="createQuiz">إنشاء الاختبار</button>
    <div id="result" class="muted"></div>
  </div>
</main>
<script>
const $=s=>document.querySelector(s);
function token(){ return localStorage.getItem('TOKEN')||''; }
function authHeaders(){ return {'Content-Type':'application/json','Authorization':'Bearer '+token()}; }
function toggleUI(logged){ document.getElementById('authCard').style.display=logged?'none':'block'; document.getElementById('builder').style.display=logged?'block':'none'; }
document.getElementById('doRegister').onclick=async()=>{
  const r=await fetch('/api/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:$('#email').value.trim(),name:$('#name').value.trim(),password:$('#pwd').value})});
  const d=await r.json(); if(!r.ok){$('#authMsg').textContent=d.error||'خطأ'; return;} localStorage.setItem('TOKEN',d.token); toggleUI(true);
};
document.getElementById('doLogin').onclick=async()=>{
  const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:$('#email').value.trim(),password:$('#pwd').value})});
  const d=await r.json(); if(!r.ok){$('#authMsg').textContent=d.error||'خطأ'; return;} localStorage.setItem('TOKEN',d.token); toggleUI(true);
};
toggleUI(!!token());

const qList=$('#qList');
function addQ(){
  const div=document.createElement('div'); div.className='card';
  div.innerHTML=`
    <div class="row">
      <select class="input qtype"><option value="mcq">اختيارات متعددة</option><option value="tf">صح / خطأ</option></select>
      <input class="input q" placeholder="نص السؤال"/>
    </div>
    <div class="mcq">
      <div class="row"><input class="input c0" placeholder="الخيار 1"/><input class="input c1" placeholder="الخيار 2"/><input class="input c2" placeholder="الخيار 3"/><input class="input c3" placeholder="الخيار 4"/></div>
      <select class="input correct"><option value="0">الصحيحة: 1</option><option value="1">الصحيحة: 2</option><option value="2">الصحيحة: 3</option><option value="3">الصحيحة: 4</option></select>
    </div>
    <div class="tf" style="display:none">
      <div class="row"><select class="input tfCorrect"><option value="0">الصحيحة: صحيح</option><option value="1">الصحيحة: خطأ</option></select></div>
      <div class="muted">الخيارات: [صحيح، خطأ] تلقائيًا.</div>
    </div>`;
  const typeSel=div.querySelector('.qtype'); const mcq=div.querySelector('.mcq'); const tf=div.querySelector('.tf');
  typeSel.addEventListener('change',()=>{ const isTF=typeSel.value==='tf'; mcq.style.display=isTF?'none':'block'; tf.style.display=isTF?'block':'none'; });
  qList.appendChild(div);
}
addQ();
document.getElementById('addQuestion').onclick=addQ;

document.getElementById('createQuiz').onclick=async()=>{
  const examDate=document.getElementById('examDate').value;
  const body={ title:document.getElementById('title').value.trim(), perQuestionSec:parseInt(document.getElementById('perSec').value||'60',10), courseName:document.getElementById('courseName').value.trim(), courseCode:document.getElementById('courseCode').value.trim(), instructorName:document.getElementById('instructorName').value.trim(), requireApproval:document.getElementById('requireApproval').checked, singleAttempt:document.getElementById('singleAttempt').checked, examStart: examDate? Date.parse(examDate): null, questions:[...qList.querySelectorAll('.card')].map(c=>{ const type=c.querySelector('.qtype').value; const text=c.querySelector('.q').value.trim(); if(type==='tf'){ const correct=parseInt(c.querySelector('.tfCorrect').value,10); return {q:text,choices:['صحيح','خطأ'],correct}; } else { const choices=[0,1,2,3].map(i=>c.querySelector('.c'+i).value.trim()); const correct=parseInt(c.querySelector('.correct').value,10); return {q:text,choices,correct}; } }).filter(x=>x.q && x.choices.every(Boolean)) };
  const r=await fetch('/api/quizzes',{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
  const d=await r.json(); if(!r.ok){ document.getElementById('result').textContent='❌ '+(d.error||'خطأ'); return; }
  document.getElementById('result').innerHTML=`✅ تم الإنشاء. رابط الطالب: <a href="/q/${d.quizId}" target="_blank">/q/${d.quizId}</a> — Quiz ID: <b>${d.quizId}</b>`;
};
</script></body></html>