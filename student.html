
<!doctype html>
<html lang="ar" dir="rtl"><head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>اختبار الطالب</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  
<header>
  <div class="container header-inner">
    <div class="brand">
      <img src="logo.png" alt="شعار الأصالة" />
      <div class="title">كليات الأصالة – كلية القانون</div>
    </div>
    <nav>
      <a href="index.html">الرئيسية</a>
      <a href="instructions.html">تعليمات سريعة</a>
      <a href="contact.html">تواصل مع الإدارة</a>
      <a href="login.html">دخول أعضاء هيئة التدريس</a>
      <a href="admin.html">الإدارة</a>
    </nav>
  </div>
</header>

  <main class="container form">
    <div id="pre" class="card">
      <h2>تعليمات قبل البدء</h2>
      <ul>
        <li>لا تغادر الصفحة أثناء الاختبار.</li>
        <li>هناك مؤقّت لكل سؤال.</li>
        <li>أدخل بياناتك بدقة.</li>
      </ul>
      <label>اسم الطالب</label><input id="sname">
      <label>الرقم الجامعي</label><input id="sid">
      <div class="actions"><button class="btn" onclick="start()">بدء الاختبار</button></div>
    </div>

    <div id="quizBox" style="display:none"></div>
    <div id="resultBox" style="display:none" class="card"></div>
  </main>
  <footer class="footer">تم تطوير المنصة بواسطة د. محمد الشمراني</footer>
  <script>
    const params=new URLSearchParams(location.search); const id=params.get('id');
    const quizzes=JSON.parse(localStorage.getItem('quizzes')||'[]'); const quiz=quizzes.find(q=>q.id===id);
    if(!quiz){ document.body.innerHTML='<div class="container"><div class="warning">الرابط غير صالح.</div></div>'; throw new Error('no quiz'); }

    let idx=0, answers=[], timer=null;
    function start(){
      if(!sname.value.trim()||!sid.value.trim()){ alert('أدخل بياناتك'); return; }
      document.getElementById('pre').style.display='none';
      document.getElementById('quizBox').style.display='block';
      window.onblur = ()=>{ alert('تم رصد مغادرة الصفحة.'); };
      renderQ();
    }
    function renderQ(){
      const box=document.getElementById('quizBox');
      const it=quiz.items[idx];
      box.className='card';
      let html='<h3>سؤال '+(idx+1)+' / '+quiz.items.length+'</h3><div id="timer" class="badge"></div>';
      html += '<p style="margin:8px 0">'+it.q+'</p>';
      if(it.type==='mcq'){
        it.options.forEach((o,i)=>{ html+='<label><input type="radio" name="ans" value="'+i+'"> '+o+'</label><br>'; });
      } else {
        html+='<label><input type="radio" name="ans" value="true"> صح</label> &nbsp;&nbsp; <label><input type="radio" name="ans" value="false"> خطأ</label>';
      }
      html+='<div class="actions"><button class="btn" onclick="nextQ()">التالي</button></div>';
      box.innerHTML=html;
      startTimer(quiz.perSec);
    }
    function startTimer(sec){
      let left=sec; updateTimer(left); clearInterval(timer);
      timer=setInterval(()=>{ left--; updateTimer(left); if(left<=0) nextQ(); },1000);
    }
    function updateTimer(v){ const t=document.getElementById('timer'); if(t) t.textContent='الوقت المتبقي: '+v+' ث'; }
    function nextQ(){
      clearInterval(timer);
      const chosen=(document.querySelector('input[name="ans"]:checked')||{}).value;
      answers[idx]=chosen;
      idx++;
      if(idx<quiz.items.length) renderQ(); else finish();
    }
    function finish(){
      document.getElementById('quizBox').style.display='none';
      let correct=0;
      quiz.items.forEach((it,i)=>{
        const c=answers[i];
        if(it.type==='mcq'){ if(parseInt(c||'-1',10)===it.correct) correct++; }
        else { if(String(it.correct)===c) correct++; }
      });
      const total=quiz.items.length; const score=Math.round(correct*100/total);
      const all=JSON.parse(localStorage.getItem('studentResults')||'[]');
      all.unshift({
        quizId:quiz.id, owner:quiz.owner, quizTitle:quiz.title,
        student:{name:sname.value.trim(), id:sid.value.trim()},
        correct,total,score, at:new Date().toISOString()
      });
      localStorage.setItem('studentResults', JSON.stringify(all));

      const r=document.getElementById('resultBox'); r.style.display='block';
      r.innerHTML = '<h2>نتيجتك</h2><div>الاختبار: <b>'+quiz.title+
        '</b><br>الدرجة: <b>'+score+'%</b><br>صحيحة: '+correct+' / '+total+'</div>'+
        '<div class="success" style="margin-top:12px">تم إرسال نتيجتك تلقائيًا لمدرّس المقرر، ويمكنه رؤيتها في صفحة النتائج.</div>'+
        '<div class="actions"><a class="btn outline" href="index.html">الرئيسية</a></div>';
    }
  </script>
</body></html>
