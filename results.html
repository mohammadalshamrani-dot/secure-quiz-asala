<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>نتائج الطلاب</title>
  <link rel="stylesheet" href="styles/main.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container">
  <header class="space-between">
    <h1>نتائج الطلاب</h1>
    <a class="link" href="index.html">الصفحة الرئيسية</a>
  </header>

  <section class="card">
    <label>رقم الاختبار (quizId)
      <input id="quizId" placeholder="مثال: QZ123">
    </label>
    <button id="load" class="btn">تحميل النتائج</button>
  </section>

  <section class="card">
    <h2>الملخص</h2>
    <div id="summary"></div>
    <canvas id="gradesChart" height="120"></canvas>
  </section>

  <script src="src/js/config.js"></script>
  <script src="src/js/auth.js"></script>
  <script src="src/js/api.js"></script>
  <script>
    function getParam(name){ const u=new URLSearchParams(location.search); return u.get(name) || ''; }
    const quizInput = document.getElementById('quizId');
    quizInput.value = getParam('quiz') || '';

    document.getElementById('load').onclick = async () => {
      if(!Auth.ensureAuthOrRedirect()) return;
      const id = quizInput.value.trim();
      if(!id){ alert('أدخل رقم الاختبار'); return; }
      try{
        const data = await API.request('/api/results?quiz='+encodeURIComponent(id), { method:'GET', auth:true });
        document.getElementById('summary').innerHTML =
          'المشاركون: '+data.participants+' — نسبة النجاح: '+Math.round(data.successRate*100)+'% — المتوسط: '+data.average.toFixed(2);

        const ctx = document.getElementById('gradesChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.histogram.map(x=>x.label),
            datasets: [{ label:'عدد الطلاب', data: data.histogram.map(x=>x.count) }]
          }
        });
      }catch(err){
        alert('تعذر تحميل النتائج: '+err.message);
      }
    };
  </script>
</body>
</html>
