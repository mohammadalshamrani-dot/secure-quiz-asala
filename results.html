
<!doctype html>
<html lang="ar" dir="rtl"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>نتائج الطلاب – كليات الأصالة</title>
<link rel="stylesheet" href="css/style.css"/><link rel="icon" type="image/x-icon" href="assets/favicon.ico">
<script defer src="assets/common.js"></script>
<style>.grp{margin:14px 0;padding:12px;border:1px solid #eee;border-radius:14px;background:#fff}</style>
</head>
<body>
<header class="header">
  <a href="member-home.html" class="brand"><img src="assets/asala-logo.jpg" class="logo">
    <div><div class="title">كليات الأصالة – كلية القانون</div><div class="subtitle">منصة الاختبارات القصيرة</div></div></a>
  <div style="margin-inline-start:auto"><a class="btn" href="member-home.html">رجوع</a></div>
</header>
<main class="container">
  <div class="card">
    <h2>نتائج الطلاب</h2>
    <div id="wrap"></div>
  </div>
</main>
<footer class="footer">تم تطوير المنصة بواسطة: د. محمد الشمراني – 2025</footer>

<script>
const uid = localStorage.getItem('asala_current_user'); if(!uid){ location.href='auth.html'; }
const quizzes = listQuizzes().filter(q=>q.owner===uid);
const results = listResults().filter(r=>r.owner===uid);

// Group by quiz
const map = new Map();
for(const q of quizzes){ map.set(q.id, {quiz:q, rows:[]}); }
for(const r of results){ if(map.has(r.quizId)) map.get(r.quizId).rows.push(r); }

function toCSV(rows){
  const headers = ['#','التاريخ','الرقم الجامعي','الاسم','الدرجة','المخالفات'];
  const lines = [headers.join(',')];
  rows.forEach((r,idx)=>{
    const item = [idx+1, r.createdAt, r.studentId||'', r.studentName||'', r.score, r.fouls||0];
    lines.push(item.map(x=>`"${String(x).replaceAll('"','""')}"`).join(','));
  });
  return lines.join('\n');
}

function download(name, text){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text], {type:'text/csv;charset=utf-8;'}));
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

function render(){
  const wrap = document.getElementById('wrap');
  if(!quizzes.length){ wrap.innerHTML='<p class="note">لا توجد اختبارات محفوظة بعد.</p>'; return; }
  wrap.innerHTML = '';
  for(const [qid, obj] of map){
    const q = obj.quiz, rows = obj.rows.sort((a,b)=>a.createdAt.localeCompare(b.createdAt));
    const div = document.createElement('div'); div.className='grp';
    const avg = rows.length? Math.round(rows.reduce((s,x)=>s+x.score,0)/rows.length) : 0;
    div.innerHTML = `<h3>${q.title}</h3>
      <p class="note">عدد المحاولات: <b>${rows.length}</b> — المتوسط: <b>${avg}%</b></p>
      <div style="margin:.5rem 0 1rem"><button class="btn btn-ghost" data-csv>تصدير CSV</button></div>
      <div style="overflow:auto">
        <table class="table"><thead><tr><th>#</th><th>التاريخ</th><th>الرقم الجامعي</th><th>الاسم</th><th>الدرجة</th><th>مخالفات</th></tr></thead><tbody>${
          rows.map((r,idx)=>`<tr><td>${idx+1}</td><td>${r.createdAt}</td><td>${r.studentId||''}</td><td>${r.studentName||''}</td><td>${r.score}%</td><td>${r.fouls||0}</td></tr>`).join('')
        }</tbody></table>
      </div>`;
    wrap.appendChild(div);
    const btn = div.querySelector('[data-csv]');
    btn.addEventListener('click', ()=> download(`${q.title.replace(/\s+/g,'_')}_results.csv`, toCSV(rows)));
  }
}
render();
</script>

</body></html>
