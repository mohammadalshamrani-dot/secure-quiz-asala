<!doctype html>
<html lang="ar" dir="rtl"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>لوحة تحكم الأدمن (جاهزة للعمل دون خادم) (إدارة عامة) – كليات الأصالة</title>
<link rel="stylesheet" href="css/style.css"/><link rel="icon" type="image/x-icon" href="assets/favicon.ico">
<script defer src="assets/common.js"></script></head>
<body>
<header class="header" dir="rtl"><a href="index.html" class="brand"><img src="assets/asala-logo.jpg" class="logo"><div><div class="title">كليات الأصالة – كلية القانون</div><div class="subtitle">منصة الاختبارات القصيرة</div></div></a></header>
<main class="container">
  <div class="card">
    <h2 class="section-title">لوحة تحكم الأدمن (جاهزة للعمل دون خادم)</h2>
    <div class="actions" style="justify-content:flex-start;margin-bottom:6px">
      <a class="btn btn-ghost" href="admin-settings.html">إعدادات البريد</a>
      <a class="btn btn-ghost" href="contact.html">التواصل مع الإدارة</a>
    </div>
    <form id="adminLogin" class="form-grid">
      <label>اسم المستخدم</label><input name="username" class="input" required>
      <label>كلمة المرور</label><input name="password" type="password" class="input" required>
      <button class="btn btn-primary" type="submit">دخول</button>
      <a href="forgot.html" class="note">نسيت كلمة المرور؟</a>
    </form>
    <section id="adminPanel" hidden>
      <h3>نظرة عامة</h3><div class="actions" id="metrics"></div>
      <h3>الشكاوى/المراسلات الواردة</h3><div id="complaints" class="table-wrap"></div>
      <h3>المستخدمون</h3><div id="usersTable" class="table-wrap"></div>
      <h3>الاختبارات</h3><div id="quizzesTable" class="table-wrap"></div>
    </section>
  </div>
</main>
<footer class="footer" dir="rtl"><div class="credit">تم تطوير المنصة بواسطة: د. محمد الشمراني – 2025</div><div class="note">© جميع الحقوق محفوظة</div></footer>
<button class="btn-back-bottom" onclick="goBack()">↩︎ رجوع</button>
<script>

document.getElementById('adminLogin').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const u = fd.get('username').trim();
  const p = fd.get('password');
  // Try server first
  let serverOK = false;
  try{
    const r = await fetch('/api/admin/login',{method:'POST',body:fd});
    if(r.ok){ const {token}=await r.json(); localStorage.setItem('admin_token',token); serverOK = True; }
  }catch(_){}
  if(serverOK){
    e.target.hidden=true; document.getElementById('adminPanel').hidden=false; loadDashboard(); return;
  }
  // Fallback local
  if(u === (window.__asala_auth && window.__asala_auth.adminUser) && p === (window.__asala_auth && window.__asala_auth.getAdminPassword())){
    localStorage.setItem('admin_token','local');
    e.target.hidden=true; document.getElementById('adminPanel').hidden=false; loadDashboard();
  } else {
    alert('بيانات الدخول غير صحيحة.');
  }
});
async function aFetch(url){const t=localStorage.getItem('admin_token');const r=await fetch(url,{headers:{Authorization:`Bearer ${t}`}});if(!r.ok) throw 0;return r.json();}
async function loadDashboard(){
  try{const m=await aFetch('/api/admin/metrics');metrics.innerHTML=[`<div class="card">المستخدمون: <strong>${m.users}</strong></div>`,`<div class="card">الاختبارات: <strong>${m.quizzes}</strong></div>`,`<div class="card">محاولات اليوم: <strong>${m.today}</strong></div>`].join('');}
  catch(e){metrics.innerHTML='<p class="note">اربط مسار /api/admin/metrics لعرض الإحصاءات.</p>';}
  renderComplaints();
  try{const users=await aFetch('/api/admin/users');usersTable.innerHTML=renderTable(users,['id','name','email','role','createdAt']);}
  catch(e){usersTable.innerHTML='<p class="note">اربط /api/admin/users لعرض المستخدمين.</p>';}
  try{const quizzes=await aFetch('/api/admin/quizzes');quizzesTable.innerHTML=renderTable(quizzes,['id','course','title','questions','createdBy','createdAt']);}
  catch(e){quizzesTable.innerHTML='<p class="note">اربط /api/admin/quizzes لعرض الاختبارات.</p>';}
}
function renderTable(rows,cols){return `<table class="table"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead><tbody>${rows.map(r=>`<tr>${cols.map(c=>`<td>${r[c]??''}</td>`).join('')}</tr>`).join('')}</tbody></table>`;}
function renderComplaints(){const rows=loadComplaintsLocally();complaints.innerHTML=rows.length?renderTable(rows,['savedAt','type','name','email','message']):'<p class="note">لا توجد شكاوى محفوظة محليًا بعد.</p>';}
</script>
</body></html>
